/**
 * Local Facebook Messenger Test
 * Test Facebook API integration before deploying to Cloudflare Workers
 */

// Your Facebook credentials (we'll set these as env vars)
const FACEBOOK_PAGE_TOKEN = process.env.FACEBOOK_PAGE_TOKEN;
const FACEBOOK_RECIPIENT_ID = process.env.FACEBOOK_RECIPIENT_ID;

/**
 * Test Facebook Graph API connectivity
 */
async function testFacebookAPI() {
  console.log('ğŸ§ª Testing Facebook API...');
  
  if (!FACEBOOK_PAGE_TOKEN || !FACEBOOK_RECIPIENT_ID) {
    console.error('âŒ Missing Facebook credentials');
    console.log('Set environment variables:');
    console.log('export FACEBOOK_PAGE_TOKEN="your_token"');
    console.log('export FACEBOOK_RECIPIENT_ID="your_recipient_id"');
    return;
  }
  
  console.log(`ğŸ” Token length: ${FACEBOOK_PAGE_TOKEN.length}`);
  console.log(`ğŸ” Recipient ID: ${FACEBOOK_RECIPIENT_ID}`);
  
  try {
    // Test 1: Verify token by getting page info
    console.log('\nğŸ“‹ Test 1: Verifying token with Graph API...');
    const pageInfoResponse = await fetch(`https://graph.facebook.com/v18.0/me?access_token=${FACEBOOK_PAGE_TOKEN}`);
    const pageInfo = await pageInfoResponse.json();
    
    if (pageInfoResponse.ok) {
      console.log('âœ… Token is valid!');
      console.log(`ğŸ“„ Page: ${pageInfo.name} (ID: ${pageInfo.id})`);
    } else {
      console.log('âŒ Token validation failed:');
      console.log(pageInfo);
      return;
    }
    
    // Test 2: Send a test message
    console.log('\nğŸ“¨ Test 2: Sending test message...');
    const testMessage = `ğŸ§ª Local Test: ${new Date().toLocaleString()}\n\nTesting Facebook Messenger integration for TFT Trading System.\n\nIf you see this, the integration is working! ğŸ‰`;
    
    const messageResponse = await fetch(`https://graph.facebook.com/v18.0/me/messages?access_token=${FACEBOOK_PAGE_TOKEN}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        recipient: {
          id: FACEBOOK_RECIPIENT_ID
        },
        message: {
          text: testMessage
        },
        messaging_type: 'MESSAGE_TAG',
        tag: 'ACCOUNT_UPDATE'
      })
    });
    
    const messageResult = await messageResponse.json();
    
    if (messageResponse.ok) {
      console.log('âœ… Test message sent successfully!');
      console.log(`ğŸ“¨ Message ID: ${messageResult.message_id}`);
      console.log(`ğŸ‘¤ Recipient ID: ${messageResult.recipient_id}`);
    } else {
      console.log('âŒ Message sending failed:');
      console.log(messageResult);
    }
    
    // Test 3: Simulate trading summary message
    console.log('\nğŸ“Š Test 3: Sending trading summary...');
    const tradingSummary = `ğŸ“Š Daily Trading Summary - ${new Date().toLocaleDateString()}\n\nğŸ“ˆ Today's Analysis (5 symbols):\n\nğŸ’­ AAPL: HOLD NEUTRAL\n   ğŸ’° $238.47 | 68.2%\n   NEUTRAL price prediction (TFT+N-HITS-Ensemble)...\n\nğŸ’­ TSLA: HOLD NEUTRAL\n   ğŸ’° $334.09 | 67.8%\n   NEUTRAL price prediction (TFT+N-HITS-Ensemble)...\n\nğŸ“Š Performance Metrics:\nâ€¢ Success Rate: 100.0%\nâ€¢ Average Confidence: 68.0%\nâ€¢ High Confidence Signals: 0\nâ€¢ Signal Distribution: {"BUY":0,"SELL":0,"HOLD":5}\n\nğŸ¤– Generated by TFT Trading System`;
    
    const summaryResponse = await fetch(`https://graph.facebook.com/v18.0/me/messages?access_token=${FACEBOOK_PAGE_TOKEN}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        recipient: {
          id: FACEBOOK_RECIPIENT_ID
        },
        message: {
          text: tradingSummary
        },
        messaging_type: 'MESSAGE_TAG',
        tag: 'ACCOUNT_UPDATE'
      })
    });
    
    const summaryResult = await summaryResponse.json();
    
    if (summaryResponse.ok) {
      console.log('âœ… Trading summary sent successfully!');
      console.log(`ğŸ“¨ Summary Message ID: ${summaryResult.message_id}`);
    } else {
      console.log('âŒ Trading summary failed:');
      console.log(summaryResult);
    }
    
  } catch (error) {
    console.error('âŒ Test failed with error:', error.message);
  }
}

// Run the test
testFacebookAPI();