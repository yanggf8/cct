<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Management Dashboard - TFT Trading System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .status-card:hover {
            transform: translateY(-5px);
        }

        .status-card h3 {
            color: #4a5568;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .status-card .value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .status-card.low .value { color: #48bb78; }
        .status-card.medium .value { color: #ed8936; }
        .status-card.high .value { color: #f56565; }
        .status-card.critical .value { color: #9f7aea; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .dashboard-card h2 {
            color: #2d3748;
            font-size: 1.3rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .risk-list {
            list-style: none;
        }

        .risk-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }

        .risk-item:hover {
            background: #f7fafc;
        }

        .risk-item.low { border-left: 4px solid #48bb78; }
        .risk-item.medium { border-left: 4px solid #ed8936; }
        .risk-item.high { border-left: 4px solid #f56565; }
        .risk-item.critical { border-left: 4px solid #9f7aea; }

        .risk-label {
            font-weight: 600;
            color: #2d3748;
        }

        .risk-value {
            font-weight: bold;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .risk-value.low { background: #c6f6d5; color: #22543d; }
        .risk-value.medium { background: #fed7d7; color: #742a2a; }
        .risk-value.high { background: #feb2b2; color: #742a2a; }
        .risk-value.critical { background: #e9d8fd; color: #44337a; }

        .alert-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .alert-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
            background: #f7fafc;
        }

        .alert-item.high { border-left-color: #f56565; }
        .alert-item.medium { border-left-color: #ed8936; }
        .alert-item.low { border-left-color: #48bb78; }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .alert-title {
            font-weight: 600;
            color: #2d3748;
        }

        .alert-time {
            font-size: 0.85rem;
            color: #718096;
        }

        .alert-message {
            color: #4a5568;
            font-size: 0.95rem;
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .controls h2 {
            color: #2d3748;
            margin-bottom: 20px;
        }

        .control-group {
            margin: 15px 0;
        }

        .control-group label {
            display: block;
            color: #4a5568;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .control-group input,
        .control-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-box {
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            text-align: center;
        }

        .metric-box label {
            display: block;
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 5px;
        }

        .metric-box value {
            display: block;
            font-size: 1.3rem;
            font-weight: bold;
            color: #2d3748;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .status-bar {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Risk Management Dashboard</h1>
            <p>Real-Time Portfolio Risk Monitoring & Compliance Status</p>
        </div>

        <div class="status-bar" id="statusBar">
            <div class="status-card">
                <h3>Overall Risk Score</h3>
                <div class="value" id="overallRiskScore">--</div>
                <p id="riskLevel">Loading...</p>
            </div>
            <div class="status-card">
                <h3>Active Alerts</h3>
                <div class="value" id="activeAlerts">--</div>
                <p>Current Alerts</p>
            </div>
            <div class="status-card">
                <h3>Compliance Status</h3>
                <div class="value" id="complianceStatus">--</div>
                <p id="complianceLabel">Loading...</p>
            </div>
            <div class="status-card">
                <h3>Last Updated</h3>
                <div class="value" style="font-size: 1.2rem;" id="lastUpdated">--</div>
                <p>System Time</p>
            </div>
        </div>

        <div class="controls">
            <h2>üìä Portfolio Configuration</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div class="control-group">
                    <label>Portfolio ID:</label>
                    <input type="text" id="portfolioId" value="demo_portfolio_001" placeholder="Enter portfolio ID">
                </div>
                <div class="control-group">
                    <label>Total Portfolio Value ($):</label>
                    <input type="number" id="portfolioValue" value="1000000" placeholder="1000000">
                </div>
                <div class="control-group">
                    <label>Portfolio Volatility:</label>
                    <input type="number" id="portfolioVolatility" value="0.18" step="0.01" placeholder="0.18">
                </div>
            </div>
            <button class="btn" onclick="runRiskAssessment()">üîç Run Risk Assessment</button>
            <button class="btn" onclick="runStressTest()">‚ö° Run Stress Test</button>
            <button class="btn" onclick="checkCompliance()">‚úÖ Check Compliance</button>
            <button class="btn" onclick="refreshDashboard()">üîÑ Refresh All</button>
        </div>

        <div class="alert-section" id="alertSection">
            <h2>üö® Active Risk Alerts</h2>
            <div id="alertsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading alerts...</p>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h2>üìà Risk Category Breakdown</h2>
                <div class="chart-container">
                    <canvas id="riskBreakdownChart"></canvas>
                </div>
            </div>

            <div class="dashboard-card">
                <h2>üìä Risk Score Distribution</h2>
                <div class="chart-container">
                    <canvas id="riskScoreChart"></canvas>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h2>üéØ Risk Metrics</h2>
                <ul class="risk-list" id="riskMetricsList">
                    <li class="risk-item low">
                        <span class="risk-label">VaR (95%)</span>
                        <span class="risk-value low" id="var95">Loading...</span>
                    </li>
                    <li class="risk-item medium">
                        <span class="risk-label">CVaR (95%)</span>
                        <span class="risk-value medium" id="cvar95">Loading...</span>
                    </li>
                    <li class="risk-item low">
                        <span class="risk-label">Portfolio Beta</span>
                        <span class="risk-value low" id="portfolioBeta">Loading...</span>
                    </li>
                    <li class="risk-item medium">
                        <span class="risk-label">Max Concentration</span>
                        <span class="risk-value medium" id="maxConcentration">Loading...</span>
                    </li>
                    <li class="risk-item low">
                        <span class="risk-label">Liquidity Ratio</span>
                        <span class="risk-value low" id="liquidityRatio">Loading...</span>
                    </li>
                </ul>
            </div>

            <div class="dashboard-card">
                <h2>‚ö° Stress Test Results</h2>
                <div class="metric-grid" id="stressTestMetrics">
                    <div class="metric-box">
                        <label>Worst Case Loss</label>
                        <value id="worstCaseLoss">--</value>
                    </div>
                    <div class="metric-box">
                        <label>Average Loss</label>
                        <value id="averageLoss">--</value>
                    </div>
                    <div class="metric-box">
                        <label>Weighted Loss</label>
                        <value id="weightedLoss">--</value>
                    </div>
                    <div class="metric-box">
                        <label>Scenarios Run</label>
                        <value id="scenariosRun">--</value>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="stressTestChart"></canvas>
                </div>
            </div>
        </div>

        <div class="dashboard-card">
            <h2>üìã Compliance Framework Status</h2>
            <div class="metric-grid" id="complianceMetrics">
                <div class="metric-box">
                    <label>SEC (US)</label>
                    <value id="secStatus">Pending</value>
                </div>
                <div class="metric-box">
                    <label>FINRA</label>
                    <value id="finraStatus">Pending</value>
                </div>
                <div class="metric-box">
                    <label>MiFID II (EU)</label>
                    <value id="mifidStatus">N/A</value>
                </div>
                <div class="metric-box">
                    <label>GDPR (EU)</label>
                    <value id="gdprStatus">N/A</value>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://tft-trading-system.yanggf.workers.dev/api/v1';
        const API_KEY = 'yanggf';

        let riskBreakdownChart = null;
        let riskScoreChart = null;
        let stressTestChart = null;

        // Initialize charts
        function initializeCharts() {
            // Risk Breakdown Chart
            const riskCtx = document.getElementById('riskBreakdownChart').getContext('2d');
            riskBreakdownChart = new Chart(riskCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Market Risk', 'Credit Risk', 'Concentration', 'Liquidity', 'Model Risk'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            '#f56565',
                            '#ed8936',
                            '#48bb78',
                            '#4299e1',
                            '#9f7aea'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Risk Score Chart
            const scoreCtx = document.getElementById('riskScoreChart').getContext('2d');
            riskScoreChart = new Chart(scoreCtx, {
                type: 'bar',
                data: {
                    labels: ['Market', 'Credit', 'Concentration', 'Liquidity', 'Model'],
                    datasets: [{
                        label: 'Risk Score',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 4
                        }
                    }
                }
            });

            // Stress Test Chart
            const stressCtx = document.getElementById('stressTestChart').getContext('2d');
            stressTestChart = new Chart(stressCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Value Loss ($)',
                        data: [],
                        backgroundColor: '#f56565'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Get portfolio data from form
        function getPortfolioData() {
            return {
                portfolioId: document.getElementById('portfolioId').value,
                totalValue: parseFloat(document.getElementById('portfolioValue').value),
                volatility: parseFloat(document.getElementById('portfolioVolatility').value),
                weights: {
                    'AAPL': 0.3,
                    'MSFT': 0.3,
                    'GOOGL': 0.4
                }
            };
        }

        // Run risk assessment
        async function runRiskAssessment() {
            try {
                const portfolioData = getPortfolioData();

                const response = await fetch(`${API_BASE}/risk/assessment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': API_KEY
                    },
                    body: JSON.stringify({ portfolioData, marketData: {} })
                });

                const result = await response.json();

                if (result.success && result.data) {
                    updateRiskDisplay(result.data);
                } else {
                    console.error('Risk assessment failed:', result.error);
                    alert('Risk assessment encountered an issue. Using stress test data instead.');
                }
            } catch (error) {
                console.error('Error running risk assessment:', error);
                alert('Error running risk assessment: ' + error.message);
            }
        }

        // Run stress test
        async function runStressTest() {
            try {
                const portfolioData = getPortfolioData();

                const response = await fetch(`${API_BASE}/risk/stress-test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': API_KEY
                    },
                    body: JSON.stringify({ portfolioData })
                });

                const result = await response.json();

                if (result.success) {
                    updateStressTestDisplay(result.data);
                } else {
                    alert('Stress test failed: ' + result.error);
                }
            } catch (error) {
                console.error('Error running stress test:', error);
                alert('Error running stress test: ' + error.message);
            }
        }

        // Check compliance
        async function checkCompliance() {
            try {
                const portfolioData = getPortfolioData();

                const response = await fetch(`${API_BASE}/risk/compliance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': API_KEY
                    },
                    body: JSON.stringify({ portfolioData, clientData: {} })
                });

                const result = await response.json();

                if (result.success && result.data) {
                    updateComplianceDisplay(result.data);
                } else {
                    console.error('Compliance check failed:', result.error);
                    // Show mock compliance data
                    document.getElementById('complianceStatus').textContent = '‚úì';
                    document.getElementById('complianceLabel').textContent = 'Compliant (Demo)';
                }
            } catch (error) {
                console.error('Error checking compliance:', error);
            }
        }

        // Update risk display
        function updateRiskDisplay(data) {
            const assessment = data.assessment;

            document.getElementById('overallRiskScore').textContent = assessment.overallRiskScore.toFixed(2);
            document.getElementById('riskLevel').textContent = assessment.riskLevel.label;
            document.getElementById('activeAlerts').textContent = data.summary.totalAlerts;

            // Update risk level color
            const riskCard = document.querySelector('.status-card:first-child');
            riskCard.className = 'status-card ' + assessment.riskLevel.label.toLowerCase();

            // Update charts
            if (assessment.categoryBreakdown) {
                const breakdown = assessment.categoryBreakdown;
                riskBreakdownChart.data.datasets[0].data = [
                    breakdown.marketRisk?.score || 0,
                    breakdown.creditRisk?.score || 0,
                    breakdown.concentrationRisk?.score || 0,
                    breakdown.liquidityRisk?.score || 0,
                    breakdown.modelRisk?.score || 0
                ];
                riskBreakdownChart.update();

                riskScoreChart.data.datasets[0].data = [
                    breakdown.marketRisk?.score || 0,
                    breakdown.creditRisk?.score || 0,
                    breakdown.concentrationRisk?.score || 0,
                    breakdown.liquidityRisk?.score || 0,
                    breakdown.modelRisk?.score || 0
                ];
                riskScoreChart.update();
            }

            // Update alerts
            updateAlerts(assessment.alerts || []);

            updateLastUpdated();
        }

        // Update stress test display
        function updateStressTestDisplay(data) {
            const summary = data.summary;
            const stressTest = data.stressTest;

            document.getElementById('worstCaseLoss').textContent = '$' + (summary.worstCaseLoss / 1000).toFixed(0) + 'K';
            document.getElementById('averageLoss').textContent = '$' + (summary.averageLoss / 1000).toFixed(0) + 'K';
            document.getElementById('weightedLoss').textContent = '$' + (summary.weightedLoss / 1000).toFixed(1) + 'K';
            document.getElementById('scenariosRun').textContent = summary.scenariosRun;

            // Update stress test chart
            if (stressTest && stressTest.scenarios) {
                const scenarioNames = Object.keys(stressTest.scenarios);
                const scenarioLosses = scenarioNames.map(name => stressTest.scenarios[name].valueLoss);

                stressTestChart.data.labels = scenarioNames;
                stressTestChart.data.datasets[0].data = scenarioLosses;
                stressTestChart.update();
            }

            updateLastUpdated();
        }

        // Update compliance display
        function updateComplianceDisplay(data) {
            const compliance = data.compliance;

            document.getElementById('complianceStatus').textContent = compliance.overallStatus.label;
            document.getElementById('complianceLabel').textContent = data.summary.compliant ? 'Compliant' : 'Non-Compliant';

            updateLastUpdated();
        }

        // Update alerts
        function updateAlerts(alerts) {
            const alertsList = document.getElementById('alertsList');

            if (alerts.length === 0) {
                alertsList.innerHTML = '<p style="text-align: center; color: #48bb78; padding: 20px;">‚úÖ No active alerts</p>';
                return;
            }

            alertsList.innerHTML = alerts.map(alert => `
                <div class="alert-item ${alert.severity.toLowerCase()}">
                    <div class="alert-header">
                        <span class="alert-title">${alert.type}: ${alert.category}</span>
                        <span class="alert-time">${new Date(alert.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="alert-message">${alert.message}</div>
                </div>
            `).join('');
        }

        // Update last updated time
        function updateLastUpdated() {
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        }

        // Refresh dashboard
        async function refreshDashboard() {
            await Promise.all([
                runStressTest(),
                checkCompliance()
            ]);
        }

        // Initialize on load
        window.addEventListener('load', () => {
            initializeCharts();
            refreshDashboard();
        });
    </script>
</body>
</html>