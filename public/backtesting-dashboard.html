<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtesting Results Dashboard - TFT Trading System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/api-client.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .chart-container {
            position: relative;
            height: 400px;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: transform 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-5px);
        }
        .status-badge {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .dark-mode {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark-mode .metric-card {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
        }
        .export-btn {
            transition: all 0.3s ease;
        }
        .export-btn:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-chart-line text-2xl text-indigo-600"></i>
                    <h1 class="text-2xl font-bold text-gray-900">Backtesting Results Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="refreshBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                    <button id="exportBtn" class="export-btn bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                    <button id="themeToggle" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Status Bar -->
        <div id="statusBar" class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
            <div class="flex items-center">
                <div class="loading-spinner mr-3"></div>
                <span class="text-blue-800">Loading backtesting results...</span>
            </div>
        </div>

        <!-- Run Selection -->
        <div class="mb-6 bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">Select Backtest Run</h2>
            <div class="flex items-center space-x-4">
                <select id="runSelector" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="">Choose a backtest run...</option>
                </select>
                <input type="text" id="runIdInput" placeholder="Or enter Run ID directly"
                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                <button id="loadRunBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition">
                    Load Results
                </button>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="dashboard-grid mb-8">
            <div class="metric-card text-white p-6 rounded-lg shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm">Total Return</p>
                        <p id="totalReturn" class="text-3xl font-bold">--%</p>
                    </div>
                    <i class="fas fa-chart-line text-4xl text-white/50"></i>
                </div>
            </div>

            <div class="metric-card text-white p-6 rounded-lg shadow-lg" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm">Sharpe Ratio</p>
                        <p id="sharpeRatio" class="text-3xl font-bold">--</p>
                    </div>
                    <i class="fas fa-balance-scale text-4xl text-white/50"></i>
                </div>
            </div>

            <div class="metric-card text-white p-6 rounded-lg shadow-lg" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm">Max Drawdown</p>
                        <p id="maxDrawdown" class="text-3xl font-bold">--%</p>
                    </div>
                    <i class="fas fa-arrow-down text-4xl text-white/50"></i>
                </div>
            </div>

            <div class="metric-card text-white p-6 rounded-lg shadow-lg" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm">Win Rate</p>
                        <p id="winRate" class="text-3xl font-bold">--%</p>
                    </div>
                    <i class="fas fa-trophy text-4xl text-white/50"></i>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="dashboard-grid">
            <!-- Equity Curve -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Equity Curve</h3>
                <div class="chart-container">
                    <canvas id="equityCurveChart"></canvas>
                </div>
            </div>

            <!-- Returns Distribution -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Returns Distribution</h3>
                <div class="chart-container">
                    <canvas id="returnsDistributionChart"></canvas>
                </div>
            </div>

            <!-- Monthly Returns -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Monthly Returns</h3>
                <div class="chart-container">
                    <canvas id="monthlyReturnsChart"></canvas>
                </div>
            </div>

            <!-- Drawdown Chart -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Drawdown Analysis</h3>
                <div class="chart-container">
                    <canvas id="drawdownChart"></canvas>
                </div>
            </div>

            <!-- Trade Analysis -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Trade Analysis</h3>
                <div class="chart-container">
                    <canvas id="tradeAnalysisChart"></canvas>
                </div>
            </div>

            <!-- Risk Metrics -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Risk Metrics</h3>
                <div class="chart-container">
                    <canvas id="riskMetricsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Detailed Results Table -->
        <div class="mt-8 bg-white p-6 rounded-lg shadow-lg">
            <h3 class="text-lg font-semibold mb-4">Detailed Performance Metrics</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metric</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                        </tr>
                    </thead>
                    <tbody id="metricsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Metrics will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Trade History -->
        <div class="mt-8 bg-white p-6 rounded-lg shadow-lg">
            <h3 class="text-lg font-semibold mb-4">Recent Trades</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P&L</th>
                        </tr>
                    </thead>
                    <tbody id="tradesTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Trades will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let currentRunId = null;
        let charts = {};
        let apiClient = null;

        // Initialize API client
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                apiClient = new window.APIClient('https://tft-trading-system.yanggf.workers.dev');
                await initializeDashboard();
            } catch (error) {
                console.error('Failed to initialize dashboard:', error);
                showError('Failed to initialize dashboard. Please check your connection.');
            }
        });

        // Initialize dashboard
        async function initializeDashboard() {
            setupEventListeners();
            await loadRunHistory();
            hideLoading();
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('loadRunBtn').addEventListener('click', loadRunResults);
            document.getElementById('refreshBtn').addEventListener('click', refreshCurrentRun);
            document.getElementById('exportBtn').addEventListener('click', exportResults);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Enter key support for run ID input
            document.getElementById('runIdInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loadRunResults();
                }
            });
        }

        // Load run history
        async function loadRunHistory() {
            try {
                showLoading();
                const response = await apiClient.getBacktestHistory();
                const runSelector = document.getElementById('runSelector');

                // Clear existing options
                runSelector.innerHTML = '<option value="">Choose a backtest run...</option>';

                // Add runs to selector
                if (response.success && response.data && response.data.runs) {
                    response.data.runs.forEach(run => {
                        const option = document.createElement('option');
                        option.value = run.runId;
                        option.textContent = `${run.runId} - ${new Date(run.createdAt).toLocaleDateString()} - ${run.status}`;
                        runSelector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load run history:', error);
                showError('Failed to load backtest history.');
            } finally {
                hideLoading();
            }
        }

        // Load run results
        async function loadRunResults() {
            const runSelector = document.getElementById('runSelector');
            const runIdInput = document.getElementById('runIdInput');

            currentRunId = runSelector.value || runIdInput.value.trim();

            if (!currentRunId) {
                showError('Please select or enter a run ID.');
                return;
            }

            try {
                showLoading();

                // Load results and metrics in parallel
                const [resultsResponse, metricsResponse] = await Promise.all([
                    apiClient.getBacktestResults(currentRunId),
                    apiClient.getBacktestPerformance(currentRunId)
                ]);

                if (resultsResponse.success && metricsResponse.success) {
                    displayResults(resultsResponse.data, metricsResponse.data);
                } else {
                    showError('Failed to load backtest results.');
                }
            } catch (error) {
                console.error('Failed to load run results:', error);
                showError('Failed to load backtest results. Please check the run ID and try again.');
            } finally {
                hideLoading();
            }
        }

        // Display results
        function displayResults(results, metrics) {
            // Update key metrics
            updateKeyMetrics(metrics);

            // Update charts
            updateCharts(results, metrics);

            // Update tables
            updateMetricsTable(metrics);
            updateTradesTable(results.trades || []);
        }

        // Update key metrics
        function updateKeyMetrics(metrics) {
            document.getElementById('totalReturn').textContent = formatPercentage(metrics.totalReturn || 0);
            document.getElementById('sharpeRatio').textContent = formatNumber(metrics.sharpeRatio || 0, 2);
            document.getElementById('maxDrawdown').textContent = formatPercentage(Math.abs(metrics.maxDrawdown || 0));
            document.getElementById('winRate').textContent = formatPercentage(metrics.winRate || 0);
        }

        // Update charts
        function updateCharts(results, metrics) {
            destroyExistingCharts();

            updateEquityCurve(results.equityCurve || []);
            updateReturnsDistribution(results.returns || []);
            updateMonthlyReturns(metrics.monthlyReturns || {});
            updateDrawdownChart(results.drawdowns || []);
            updateTradeAnalysis(results.trades || []);
            updateRiskMetrics(metrics);
        }

        // Equity Curve Chart
        function updateEquityCurve(equityData) {
            const ctx = document.getElementById('equityCurveChart').getContext('2d');
            charts.equityCurve = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: equityData.map(d => new Date(d.date)),
                    datasets: [{
                        label: 'Portfolio Value',
                        data: equityData.map(d => d.value),
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + formatNumber(value, 0);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Returns Distribution Chart
        function updateReturnsDistribution(returns) {
            const ctx = document.getElementById('returnsDistributionChart').getContext('2d');

            // Create histogram bins
            const bins = createHistogramBins(returns, 20);

            charts.returnsDistribution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: bins.map(b => formatPercentage(b.min) + ' to ' + formatPercentage(b.max)),
                    datasets: [{
                        label: 'Frequency',
                        data: bins.map(b => b.count),
                        backgroundColor: returns.map(r => r >= 0 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Monthly Returns Chart
        function updateMonthlyReturns(monthlyReturns) {
            const ctx = document.getElementById('monthlyReturnsChart').getContext('2d');
            const months = Object.keys(monthlyReturns).sort();

            charts.monthlyReturns = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months.map(m => new Date(m).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })),
                    datasets: [{
                        label: 'Monthly Return',
                        data: months.map(m => monthlyReturns[m]),
                        backgroundColor: months.map(m => monthlyReturns[m] >= 0 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return formatPercentage(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Drawdown Chart
        function updateDrawdownChart(drawdowns) {
            const ctx = document.getElementById('drawdownChart').getContext('2d');

            charts.drawdown = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: drawdowns.map(d => new Date(d.date)),
                    datasets: [{
                        label: 'Drawdown',
                        data: drawdowns.map(d => d.drawdown),
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 0,
                            ticks: {
                                callback: function(value) {
                                    return formatPercentage(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Trade Analysis Chart
        function updateTradeAnalysis(trades) {
            const ctx = document.getElementById('tradeAnalysisChart').getContext('2d');

            // Analyze trades by symbol
            const symbolPerformance = {};
            trades.forEach(trade => {
                if (!symbolPerformance[trade.symbol]) {
                    symbolPerformance[trade.symbol] = { count: 0, totalPnL: 0 };
                }
                symbolPerformance[trade.symbol].count++;
                symbolPerformance[trade.symbol].totalPnL += trade.pnl || 0;
            });

            const symbols = Object.keys(symbolPerformance);

            charts.tradeAnalysis = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: symbols,
                    datasets: [{
                        label: 'P&L by Symbol',
                        data: symbols.map(s => symbolPerformance[s].totalPnL),
                        backgroundColor: [
                            'rgba(99, 102, 241, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(251, 146, 60, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(147, 51, 234, 0.8)',
                            'rgba(14, 165, 233, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Risk Metrics Chart
        function updateRiskMetrics(metrics) {
            const ctx = document.getElementById('riskMetricsChart').getContext('2d');

            charts.riskMetrics = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Sharpe Ratio', 'Sortino Ratio', 'Calmar Ratio', 'Max Drawdown', 'Volatility', 'Beta'],
                    datasets: [{
                        label: 'Risk Metrics',
                        data: [
                            normalizeMetric(metrics.sharpeRatio || 0, 0, 3),
                            normalizeMetric(metrics.sortinoRatio || 0, 0, 3),
                            normalizeMetric(metrics.calmarRatio || 0, 0, 3),
                            normalizeMetric(1 - Math.abs(metrics.maxDrawdown || 0), 0, 1),
                            normalizeMetric(1 - (metrics.volatility || 0), 0, 1),
                            normalizeMetric(2 - Math.abs(metrics.beta || 1), 0, 2)
                        ],
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.2)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });
        }

        // Update metrics table
        function updateMetricsTable(metrics) {
            const tbody = document.getElementById('metricsTableBody');
            const metricsData = [
                { name: 'Total Return', value: formatPercentage(metrics.totalReturn || 0), description: 'Overall portfolio return' },
                { name: 'Annualized Return', value: formatPercentage(metrics.annualizedReturn || 0), description: 'Return annualized over the period' },
                { name: 'Sharpe Ratio', value: formatNumber(metrics.sharpeRatio || 0, 2), description: 'Risk-adjusted return metric' },
                { name: 'Sortino Ratio', value: formatNumber(metrics.sortinoRatio || 0, 2), description: 'Downside risk-adjusted return' },
                { name: 'Calmar Ratio', value: formatNumber(metrics.calmarRatio || 0, 2), description: 'Return relative to max drawdown' },
                { name: 'Max Drawdown', value: formatPercentage(Math.abs(metrics.maxDrawdown || 0)), description: 'Maximum peak-to-trough decline' },
                { name: 'Volatility', value: formatPercentage(metrics.volatility || 0), description: 'Annualized standard deviation' },
                { name: 'Beta', value: formatNumber(metrics.beta || 0, 2), description: 'Sensitivity to market movements' },
                { name: 'Alpha', value: formatPercentage(metrics.alpha || 0), description: 'Excess return over benchmark' },
                { name: 'Win Rate', value: formatPercentage(metrics.winRate || 0), description: 'Percentage of profitable trades' },
                { name: 'Profit Factor', value: formatNumber(metrics.profitFactor || 0, 2), description: 'Ratio of gross profits to losses' },
                { name: 'Average Win', value: formatCurrency(metrics.averageWin || 0), description: 'Average profit per winning trade' },
                { name: 'Average Loss', value: formatCurrency(metrics.averageLoss || 0), description: 'Average loss per losing trade' }
            ];

            tbody.innerHTML = metricsData.map(metric => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${metric.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${metric.value}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${metric.description}</td>
                </tr>
            `).join('');
        }

        // Update trades table
        function updateTradesTable(trades) {
            const tbody = document.getElementById('tradesTableBody');
            const recentTrades = trades.slice(0, 20); // Show last 20 trades

            if (recentTrades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No trades found</td></tr>';
                return;
            }

            tbody.innerHTML = recentTrades.map(trade => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(trade.date).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${trade.symbol}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            trade.type === 'BUY' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }">
                            ${trade.type}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(trade.price)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${trade.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="${trade.pnl >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${formatCurrency(trade.pnl)}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // Utility functions
        function destroyExistingCharts() {
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
        }

        function createHistogramBins(data, binCount) {
            if (data.length === 0) return [];

            const min = Math.min(...data);
            const max = Math.max(...data);
            const binWidth = (max - min) / binCount;
            const bins = [];

            for (let i = 0; i < binCount; i++) {
                const binMin = min + i * binWidth;
                const binMax = binMin + binWidth;
                const count = data.filter(d => d >= binMin && d < binMax).length;
                bins.push({ min: binMin, max: binMax, count });
            }

            return bins;
        }

        function normalizeMetric(value, min, max) {
            return (value - min) / (max - min);
        }

        function formatNumber(num, decimals = 0) {
            return num.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }

        function formatPercentage(num) {
            return formatNumber(num * 100, 2) + '%';
        }

        function formatCurrency(num) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
        }

        function showLoading() {
            document.getElementById('statusBar').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('statusBar').classList.add('hidden');
        }

        function showError(message) {
            alert(message); // Replace with better error handling UI
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const icon = document.querySelector('#themeToggle i');
            icon.classList.toggle('fa-moon');
            icon.classList.toggle('fa-sun');
        }

        async function refreshCurrentRun() {
            if (currentRunId) {
                await loadRunResults();
            } else {
                showError('No run selected. Please select a run first.');
            }
        }

        function exportResults() {
            if (!currentRunId) {
                showError('No run selected. Please select a run first.');
                return;
            }

            // Create export data
            const exportData = {
                runId: currentRunId,
                exportDate: new Date().toISOString(),
                metrics: {},
                charts: {}
            };

            // Collect data from current display
            document.querySelectorAll('#metricsTableBody tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 2) {
                    exportData.metrics[cells[0].textContent] = cells[1].textContent;
                }
            });

            // Download as JSON
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backtest-results-${currentRunId}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>