<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCT - Prediction Jobs</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="/css/nav.css?v=20251226">
    <script src="/js/nav.js?v=20251226"></script>
    <script src="/js/cct-api.js"></script>
    <script src="/js/utils/memory-manager.js"></script>
    <script src="/js/utils/market-day-helper.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #c9d1d9; --text-muted: #8b949e; --green: #3fb950; --red: #f85149; --yellow: #d29922; --blue: #58a6ff; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        h1 { font-size: 1.4rem; }
        .refresh-btn { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .refresh-btn:hover { background: var(--border); }

        .section { margin-bottom: 28px; }
        .section-header { font-size: 1.1rem; font-weight: 600; margin-bottom: 14px; display: flex; align-items: center; gap: 10px; }
        .section-header .label { color: var(--text-muted); font-weight: normal; font-size: 0.9rem; }

        .row-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; }
        .daily-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }

        .job-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 14px; position: relative; }
        .job-card.success { border-top: 3px solid var(--green); }
        .job-card.failure { border-top: 3px solid var(--red); }
        .job-card.scheduled { border-top: 3px solid var(--text-muted); }
        .job-card.skipped { border-top: 3px solid var(--border); opacity: 0.6; }
        .job-card.in_progress { border-top: 3px solid var(--yellow); }

        .job-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .job-icon { font-size: 1.3rem; }
        .job-time { font-size: 0.8rem; color: var(--text-muted); }
        .job-name { font-size: 0.95rem; font-weight: 600; margin-bottom: 6px; }
        .job-status { font-size: 0.8rem; color: var(--text-muted); }
        .job-link { position: absolute; bottom: 10px; right: 12px; color: var(--blue); text-decoration: none; font-size: 0.75rem; }
        .job-link:hover { text-decoration: underline; }

        .weekly-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .weekly-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
        .weekly-card.success { border-left: 4px solid var(--green); }
        .weekly-card.failure { border-left: 4px solid var(--red); }
        .weekly-card.scheduled { border-left: 4px solid var(--text-muted); }
        .weekly-card.skipped { border-left: 4px solid var(--border); opacity: 0.6; }
        .weekly-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 6px; }
        .weekly-date { font-size: 1rem; font-weight: 600; margin-bottom: 8px; }
        .weekly-status { font-size: 0.85rem; }

        .loading { text-align: center; padding: 30px; color: var(--text-muted); }
        @media (max-width: 600px) { .daily-grid { grid-template-columns: 1fr; } .weekly-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Prediction Jobs</h1>
            <button class="refresh-btn" onclick="loadAll()">üîÑ Refresh</button>
        </div>

        <div class="section">
            <div class="section-header">üåÖ Daily Jobs <span class="label">(Mon-Fri)</span></div>
            <div id="market-status" style="margin-bottom: 10px; padding: 8px 12px; background: var(--card); border: 1px solid var(--border); border-radius: 6px; font-size: 0.85rem;">
                <span id="market-status-icon">‚è≥</span>
                <span id="market-status-text">Loading market status...</span>
            </div>
            <div id="daily-section"><div class="loading">Loading...</div></div>
        </div>

        <div class="section">
            <div class="section-header">üìã Weekly Review <span class="label">(Sunday 10:00 AM EST)</span></div>
            <div id="weekly-section"><div class="loading">Loading...</div></div>
        </div>
    </div>

    <script>
        const DAILY_JOBS = [
            { id: 'pre-market', name: 'Pre-Market', icon: 'üåÖ', hour: 12, min: 30, type: 'analysis' },
            { id: 'intraday', name: 'Intraday', icon: 'üìä', hour: 16, min: 0, type: 'analysis' },
            { id: 'end-of-day', name: 'End-of-Day', icon: 'üåÜ', hour: 20, min: 5, type: 'analysis' }
        ];

        let d1Jobs = [];

        async function fetchD1Jobs() {
            try {
                const data = await cctApi.jobsHistory(50);
                return data.success ? (data.data.jobs || []) : [];
            } catch (e) {
                console.error('Failed to fetch D1 jobs:', e);
                return [];
            }
        }

        function statusText(status) {
            return { success: '‚úÖ Completed', failure: '‚ùå Failed', in_progress: 'üîÑ Running', skipped: '‚ö™ Skipped' }[status] || '‚ö™ No run';
        }

        function formatTime(h, m) {
            const estH = (h - 5 + 24) % 24;
            const etTime = `${estH % 12 || 12}:${m.toString().padStart(2, '0')} ${estH >= 12 ? 'PM' : 'AM'} ET`;
            // Convert UTC to local time
            const utcDate = new Date(Date.UTC(2024, 0, 1, h, m));
            const localTime = utcDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            return `${etTime} (${localTime} local)`;
        }

        function getDateStr(d) { return d.toISOString().slice(0, 10); }
        
        function getUTCToday() {
            const now = new Date();
            return new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
        }

        function getJobRunForDate(dateStr, jobId) {
            // Match by date and expected hour window (¬±2h tolerance)
            const jobHours = { 'pre-market': 12, 'intraday': 16, 'end-of-day': 20 };
            const expectedHour = jobHours[jobId];
            if (expectedHour === undefined) return null;
            
            return d1Jobs.find(j => {
                const execDate = j.executed_at.slice(0, 10);
                const execHour = new Date(j.executed_at).getUTCHours();
                return execDate === dateStr && Math.abs(execHour - expectedHour) <= 2;
            });
        }

        function renderDailySection() {
            const container = document.getElementById('daily-section');
            const now = new Date();
            const today = getUTCToday();

            // Use market day helper to get last market day
            const lastMarketDayStr = MarketDayHelper.getLastMarketDay();
            const lastMarketDay = new Date(lastMarketDayStr + 'T00:00:00');

            // Determine if yesterday was a weekend
            const yesterday = new Date(today); yesterday.setUTCDate(today.getUTCDate() - 1);
            const yesterdayIsWeekend = yesterday.getUTCDay() === 0 || yesterday.getUTCDay() === 6;

            // If yesterday was a weekend, use last market day; otherwise use yesterday
            const showDate = yesterdayIsWeekend ? lastMarketDay : yesterday;
            const labelDate = yesterdayIsWeekend ? 'üìÜ Last Market Day' : 'üìÜ Yesterday';

            const renderRow = (date, label) => {
                const dateStr = getDateStr(date);
                const isToday = getDateStr(today) === dateStr;

                const cards = DAILY_JOBS.map(job => {
                    const run = getJobRunForDate(dateStr, job.id);
                    const scheduledTime = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(), job.hour, job.min));
                    const isPast = scheduledTime < now;

                    let status, sText;
                    if (run) {
                        status = run.status === 'success' ? 'success' : 'failure';
                        sText = statusText(status);
                    } else if (!isToday || isPast) {
                        status = 'skipped';
                        sText = '‚ö™ No run';
                    } else {
                        status = 'scheduled';
                        sText = '‚è≥ Scheduled';
                    }

                    const reportLinks = {
                        'pre-market': '/pre-market-briefing',
                        'intraday': '/intraday-check',
                        'end-of-day': '/end-of-day-summary'
                    };
                    const reportLink = isToday ? reportLinks[job.id] : `${reportLinks[job.id]}?date=${dateStr}`;

                    return `
                        <a href="${reportLink}" class="job-card ${status}" style="text-decoration:none;color:inherit;display:block;">
                            <div class="job-header">
                                <span class="job-icon">${job.icon}</span>
                                <span class="job-time">${formatTime(job.hour, job.min)}</span>
                            </div>
                            <div class="job-name">${job.name}</div>
                            <div class="job-status">${sText}</div>
                            ${run ? `<div class="job-meta">${run.symbols_processed || 0} symbols</div>` : ''}
                        </a>
                    `;
                });

                return `
                    <div class="row-label">${label} ‚Äî ${date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</div>
                    <div class="daily-grid">${cards.join('')}</div>
                `;
            };

            container.innerHTML = renderRow(today, 'üìç Today') + renderRow(showDate, labelDate);
        }

        function renderWeeklySection() {
            const container = document.getElementById('weekly-section');
            const now = new Date();
            const today = getUTCToday();

            const thisSunday = new Date(today);
            thisSunday.setUTCDate(today.getUTCDate() - today.getUTCDay());
            const lastSunday = new Date(thisSunday);
            lastSunday.setUTCDate(thisSunday.getUTCDate() - 7);

            const renderWeeklyCard = (sunday, label) => {
                const dateStr = getDateStr(sunday);
                const isFuture = sunday > today;
                const isLastWeek = label === 'Last Week';
                const run = d1Jobs.find(j => {
                    const execDate = j.executed_at.slice(0, 10);
                    const execHour = new Date(j.executed_at).getUTCHours();
                    return execDate === dateStr && Math.abs(execHour - 14) <= 2;
                });

                let status, sText;
                if (run) {
                    status = run.status === 'success' ? 'success' : 'failure';
                    sText = statusText(status);
                } else if (isFuture) {
                    status = 'scheduled';
                    sText = '‚è≥ Scheduled';
                } else {
                    status = 'skipped';
                    sText = '‚ö™ No run';
                }

                const weekUrl = isLastWeek ? '/weekly-review?week=last' : '/weekly-review';

                return `
                    <a href="${weekUrl}" class="weekly-card ${status}" style="text-decoration:none;color:inherit;display:block;">
                        <div class="weekly-label">${label}</div>
                        <div class="weekly-date">üìã ${sunday.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</div>
                        <div class="weekly-status">${sText}</div>
                    </a>
                `;
            };

            container.innerHTML = `
                <div class="weekly-grid">
                    ${renderWeeklyCard(thisSunday, 'This Week')}
                    ${renderWeeklyCard(lastSunday, 'Last Week')}
                </div>
            `;
        }

        function renderMarketStatus() {
            const statusInfo = MarketDayHelper.getMarketStatus();
            const iconEl = document.getElementById('market-status-icon');
            const textEl = document.getElementById('market-status-text');

            if (statusInfo.status === 'OPEN') {
                iconEl.textContent = 'üü¢';
                textEl.textContent = `${statusInfo.message} ‚Ä¢ Last Market Day: ${statusInfo.lastMarketDayLabel}`;
            } else {
                iconEl.textContent = 'üî¥';
                textEl.textContent = `${statusInfo.message} ‚Ä¢ Last Market Day: ${statusInfo.lastMarketDayLabel}`;
            }
        }

        async function loadAll() {
            document.getElementById('daily-section').innerHTML = '<div class="loading">Loading...</div>';
            document.getElementById('weekly-section').innerHTML = '<div class="loading">Loading...</div>';

            // Render market status first
            renderMarketStatus();

            d1Jobs = await fetchD1Jobs();
            renderDailySection();
            renderWeeklySection();
        }

        loadAll();
        // Auto-refresh every 5 minutes (300000ms) - use memory manager to prevent leaks
        memoryManager.registerInterval('dashboard-refresh', loadAll, 300000);
    </script>
</body>
</html>
