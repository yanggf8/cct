<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCT - Prediction Jobs</title>
    <link rel="stylesheet" href="/css/nav.css?v=20251223">
    <script src="/js/nav.js?v=20251223"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #c9d1d9; --text-muted: #8b949e; --green: #3fb950; --red: #f85149; --yellow: #d29922; --blue: #58a6ff; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        h1 { font-size: 1.4rem; }
        .refresh-btn { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .refresh-btn:hover { background: var(--border); }

        .section { margin-bottom: 28px; }
        .section-header { font-size: 1.1rem; font-weight: 600; margin-bottom: 14px; display: flex; align-items: center; gap: 10px; }
        .section-header .label { color: var(--text-muted); font-weight: normal; font-size: 0.9rem; }

        .row-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; }
        .daily-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }

        .job-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 14px; position: relative; }
        .job-card.success { border-top: 3px solid var(--green); }
        .job-card.failure { border-top: 3px solid var(--red); }
        .job-card.scheduled { border-top: 3px solid var(--text-muted); }
        .job-card.skipped { border-top: 3px solid var(--border); opacity: 0.6; }
        .job-card.in_progress { border-top: 3px solid var(--yellow); }

        .job-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .job-icon { font-size: 1.3rem; }
        .job-time { font-size: 0.8rem; color: var(--text-muted); }
        .job-name { font-size: 0.95rem; font-weight: 600; margin-bottom: 6px; }
        .job-status { font-size: 0.8rem; color: var(--text-muted); }
        .job-link { position: absolute; bottom: 10px; right: 12px; color: var(--blue); text-decoration: none; font-size: 0.75rem; }
        .job-link:hover { text-decoration: underline; }

        .weekly-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .weekly-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
        .weekly-card.success { border-left: 4px solid var(--green); }
        .weekly-card.failure { border-left: 4px solid var(--red); }
        .weekly-card.scheduled { border-left: 4px solid var(--text-muted); }
        .weekly-card.skipped { border-left: 4px solid var(--border); opacity: 0.6; }
        .weekly-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 6px; }
        .weekly-date { font-size: 1rem; font-weight: 600; margin-bottom: 8px; }
        .weekly-status { font-size: 0.85rem; }

        .loading { text-align: center; padding: 30px; color: var(--text-muted); }
        @media (max-width: 600px) { .daily-grid { grid-template-columns: 1fr; } .weekly-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Prediction Jobs</h1>
            <button class="refresh-btn" onclick="loadAll()">üîÑ Refresh</button>
        </div>

        <div class="section">
            <div class="section-header">üåÖ Daily Jobs <span class="label">(Mon-Fri)</span></div>
            <div id="daily-section"><div class="loading">Loading...</div></div>
        </div>

        <div class="section">
            <div class="section-header">üìã Weekly Review <span class="label">(Sunday 10:00 AM EST)</span></div>
            <div id="weekly-section"><div class="loading">Loading...</div></div>
        </div>
    </div>

    <script>
        const DAILY_JOBS = [
            { id: 'pre-market', name: 'Pre-Market', icon: 'üåÖ', hour: 12, min: 30 },
            { id: 'intraday', name: 'Intraday', icon: 'üìä', hour: 16, min: 0 },
            { id: 'end-of-day', name: 'End-of-Day', icon: 'üåÜ', hour: 20, min: 5 }
        ];

        let ghRuns = [];

        async function fetchGitHubRuns() {
            // GitHub Actions integration disabled - remove or configure if needed
            return [];
        }

        function normalizeStatus(run) {
            const c = run.conclusion, s = run.status;
            if (c === 'success') return 'success';
            if (c === 'failure' || c === 'timed_out') return 'failure';
            if (c === 'cancelled' || c === 'skipped') return 'skipped';
            if (s === 'queued' || s === 'in_progress' || s === 'pending') return 'in_progress';
            return c || 'in_progress';
        }

        function statusText(status) {
            return { success: '‚úÖ Completed', failure: '‚ùå Failed', in_progress: 'üîÑ Running', skipped: '‚ö™ Skipped' }[status] || '‚ö™ Unknown';
        }

        function getJobForRun(run) {
            if (run.event === 'workflow_dispatch') return null;
            const t = new Date(run.created_at);
            const h = t.getUTCHours(), m = t.getUTCMinutes();
            if (h === 14 && m <= 10 && t.getUTCDay() === 0) return { id: 'weekly-review' };
            for (const job of DAILY_JOBS) {
                if (h === job.hour && Math.abs(m - job.min) <= 10) return job;
            }
            return null;
        }

        function formatTime(h, m) {
            const estH = (h - 5 + 24) % 24;
            return `${estH % 12 || 12}:${m.toString().padStart(2, '0')} ${estH >= 12 ? 'PM' : 'AM'}`;
        }

        function getDateStr(d) { return d.toISOString().slice(0, 10); }

        function renderDailySection() {
            const container = document.getElementById('daily-section');
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);

            const renderRow = (date, label) => {
                const dateStr = getDateStr(date);
                const isToday = getDateStr(now) === dateStr;
                const dayRuns = ghRuns.filter(r => getDateStr(new Date(r.created_at)) === dateStr);

                const cards = DAILY_JOBS.map(job => {
                    const run = dayRuns.find(r => {
                        const j = getJobForRun(r);
                        return j && j.id === job.id;
                    });
                    const scheduledTime = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate(), job.hour, job.min));
                    const isPast = scheduledTime < now;

                    let status, sText;
                    if (run) {
                        status = normalizeStatus(run);
                        sText = statusText(status);
                    } else if (!isToday || isPast) {
                        status = 'skipped';
                        sText = '‚ö™ No run';
                    } else {
                        status = 'scheduled';
                        sText = '‚è≥ Scheduled';
                    }

                    return `
                        <div class="job-card ${status}">
                            <div class="job-header">
                                <span class="job-icon">${job.icon}</span>
                                <span class="job-time">${formatTime(job.hour, job.min)}</span>
                            </div>
                            <div class="job-name">${job.name}</div>
                            <div class="job-status">${sText}</div>
                            ${run ? `<a class="job-link" href="${run.html_url}" target="_blank">View ‚Üí</a>` : ''}
                        </div>
                    `;
                });

                return `
                    <div class="row-label">${label} ‚Äî ${date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</div>
                    <div class="daily-grid">${cards.join('')}</div>
                `;
            };

            container.innerHTML = renderRow(today, 'üìç Today') + renderRow(yesterday, 'üìÜ Yesterday');
        }

        function renderWeeklySection() {
            const container = document.getElementById('weekly-section');
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            // Find this Sunday and last Sunday
            const thisSunday = new Date(today);
            thisSunday.setDate(today.getDate() - today.getDay());
            const lastSunday = new Date(thisSunday);
            lastSunday.setDate(thisSunday.getDate() - 7);

            const renderWeeklyCard = (sunday, label) => {
                const dateStr = getDateStr(sunday);
                const isFuture = sunday > today;
                const run = ghRuns.find(r => {
                    const j = getJobForRun(r);
                    return j && j.id === 'weekly-review' && getDateStr(new Date(r.created_at)) === dateStr;
                });

                let status, sText;
                if (run) {
                    status = normalizeStatus(run);
                    sText = statusText(status);
                } else if (isFuture) {
                    status = 'scheduled';
                    sText = '‚è≥ Scheduled';
                } else {
                    status = 'skipped';
                    sText = '‚ö™ No run';
                }

                return `
                    <div class="weekly-card ${status}">
                        <div class="weekly-label">${label}</div>
                        <div class="weekly-date">üìã ${sunday.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</div>
                        <div class="weekly-status">${sText}</div>
                        ${run ? `<a class="job-link" href="${run.html_url}" target="_blank">View ‚Üí</a>` : ''}
                    </div>
                `;
            };

            container.innerHTML = `
                <div class="weekly-grid">
                    ${renderWeeklyCard(thisSunday, 'This Week')}
                    ${renderWeeklyCard(lastSunday, 'Last Week')}
                </div>
            `;
        }

        async function loadAll() {
            document.getElementById('daily-section').innerHTML = '<div class="loading">Loading...</div>';
            document.getElementById('weekly-section').innerHTML = '<div class="loading">Loading...</div>';

            ghRuns = await fetchGitHubRuns();
            renderDailySection();
            renderWeeklySection();
        }

        loadAll();
        setInterval(loadAll, 300000);
    </script>
</body>
</html>
