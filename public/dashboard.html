<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCT - Prediction Jobs</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="/css/nav.css?v=20251226">
    <script src="/js/nav.js?v=20251226"></script>
    <script src="/js/cct-api.js"></script>
    <script src="/js/utils/memory-manager.js"></script>
    <script src="/js/utils/market-day-helper.js"></script>
    <script src="/js/utils/shared-utils.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg: linear-gradient(160deg, #1a1714 0%, #1f1b16 40%, #2a241c 100%);
            --card: rgba(250, 248, 245, 0.03);
            --card-hover: rgba(250, 248, 245, 0.06);
            --border: rgba(240, 185, 11, 0.12);
            --text: #faf8f5;
            --text-muted: rgba(250, 248, 245, 0.65);
            --green: #10b981;
            --red: #ef4444;
            --yellow: #f59e0b;
            --gold: #f0b90b;
            --gold-bright: #fcd535;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            background-attachment: fixed;
            color: var(--text);
            min-height: 100vh;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        h1 { font-size: 1.4rem; color: var(--gold-bright); }
        .refresh-btn {
            background: linear-gradient(135deg, var(--gold), var(--gold-bright));
            border: none;
            color: #000;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(240, 185, 11, 0.3);
        }

        .section { margin-bottom: 28px; }
        .section-header { font-size: 1.1rem; font-weight: 600; margin-bottom: 14px; display: flex; align-items: center; gap: 10px; color: var(--gold); }
        .section-header .label { color: var(--text-muted); font-weight: normal; font-size: 0.9rem; }

        .row-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; }
        .daily-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }

        .job-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px;
            position: relative;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .job-card:hover {
            background: var(--card-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(240, 185, 11, 0.08);
        }
        .job-card.success { border-top: 3px solid var(--green); }
        .job-card.failed { border-top: 3px solid var(--red); }
        .job-card.running { border-top: 3px solid var(--yellow); }
        .job-card.partial { border-top: 3px solid var(--yellow); }
        .job-card.scheduled { border-top: 3px solid var(--gold); }
        .job-card.skipped { border-top: 3px solid var(--border); opacity: 0.6; }

        .job-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .job-icon { font-size: 1.3rem; }
        .job-time { font-size: 0.8rem; color: var(--text-muted); }
        .job-name { font-size: 0.95rem; font-weight: 600; margin-bottom: 6px; }
        .job-status { font-size: 0.8rem; color: var(--text-muted); }
        .job-link { position: absolute; bottom: 10px; right: 12px; color: var(--gold); text-decoration: none; font-size: 0.75rem; }
        .job-link:hover { text-decoration: underline; }

        .weekly-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .weekly-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .weekly-card:hover {
            background: var(--card-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(240, 185, 11, 0.08);
        }
        .weekly-card.success { border-left: 4px solid var(--green); }
        .weekly-card.failed { border-left: 4px solid var(--red); }
        .weekly-card.running { border-left: 4px solid var(--yellow); }
        .weekly-card.partial { border-left: 4px solid var(--yellow); }
        .weekly-card.scheduled { border-left: 4px solid var(--gold); }
        .weekly-card.skipped { border-left: 4px solid var(--border); opacity: 0.6; }
        .weekly-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 6px; }
        .weekly-date { font-size: 1rem; font-weight: 600; margin-bottom: 8px; }
        .weekly-status { font-size: 0.85rem; }

        /* Job Runs History Section */
        .runs-table { width: 100%; border-collapse: collapse; }
        .runs-table th, .runs-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border); }
        .runs-table th { color: var(--text-muted); font-weight: 500; font-size: 0.8rem; text-transform: uppercase; }
        .runs-table td { font-size: 0.85rem; }
        .runs-table tr:hover { background: var(--card-hover); }
        .run-status { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .run-status.success { background: rgba(16, 185, 129, 0.2); color: var(--green); }
        .run-status.failed { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        .run-status.running { background: rgba(245, 158, 11, 0.2); color: var(--yellow); }
        .run-status.partial { background: rgba(245, 158, 11, 0.2); color: var(--yellow); }
        .delete-btn {
            background: transparent; border: 1px solid var(--red); color: var(--red);
            padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;
            transition: all 0.2s ease;
        }
        .delete-btn:hover { background: var(--red); color: #fff; }
        .delete-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .trigger-btn {
            background: linear-gradient(135deg, var(--gold), var(--gold-bright));
            border: none; color: #000; padding: 6px 14px; border-radius: 6px;
            cursor: pointer; font-weight: 600; font-size: 0.8rem; margin-left: 10px;
        }
        .trigger-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(240, 185, 11, 0.3); }
        .run-id { font-family: monospace; font-size: 0.7rem; color: var(--text-muted); }

        /* Trigger source icons */
        .trigger-icon { font-size: 0.9rem; cursor: help; }
        .trigger-icon.scheduled { color: var(--text-muted); }
        .trigger-icon.manual { color: var(--gold); }

        /* Legend tooltip */
        .legend-container { display: flex; align-items: center; gap: 16px; margin-bottom: 12px; padding: 8px 12px; background: var(--card); border: 1px solid var(--border); border-radius: 6px; font-size: 0.8rem; }
        .legend-item { display: flex; align-items: center; gap: 6px; color: var(--text-muted); }
        .legend-item span:first-child { font-size: 1rem; }

        .loading { text-align: center; padding: 30px; color: var(--text-muted); }
        @media (max-width: 600px) { .daily-grid { grid-template-columns: 1fr; } .weekly-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Prediction Jobs</h1>
            <button class="refresh-btn" onclick="loadAll()">üîÑ Refresh</button>
        </div>

        <div class="section">
            <div class="section-header">
                üóÇÔ∏è Job Run History
                <div style="display: flex; gap: 8px; margin-left: auto;">
                    <button class="trigger-btn" onclick="triggerJob('pre-market')">+ Pre-Market</button>
                    <button class="trigger-btn" onclick="triggerJob('intraday')">+ Intraday</button>
                    <button class="trigger-btn" onclick="triggerJob('end-of-day')">+ End-of-Day</button>
                    <button class="trigger-btn" onclick="triggerJob('weekly')">+ Weekly</button>
                </div>
            </div>
            <div id="runs-section"><div class="loading">Loading...</div></div>
        </div>

        <div class="section">
            <div class="section-header">üåÖ Daily Jobs <span class="label">(Mon-Fri)</span></div>
            <div id="market-status" style="margin-bottom: 10px; padding: 8px 12px; background: var(--card); border: 1px solid var(--border); border-radius: 6px; font-size: 0.85rem;">
                <span id="market-status-icon">‚è≥</span>
                <span id="market-status-text">Loading market status...</span>
            </div>
            <div id="daily-section"><div class="loading">Loading...</div></div>
        </div>

        <div class="section">
            <div class="section-header">üìã Weekly Review <span class="label">(Sunday 10:00 AM EST)</span></div>
            <div id="weekly-section"><div class="loading">Loading...</div></div>
        </div>
    </div>

    <script>
        const DAILY_JOBS = [
            { id: 'pre-market', name: 'Pre-Market', icon: 'üåÖ', hour: 12, min: 30, type: 'analysis' },
            { id: 'intraday', name: 'Intraday', icon: 'üìä', hour: 16, min: 0, type: 'analysis' },
            { id: 'end-of-day', name: 'End-of-Day', icon: 'üåÜ', hour: 20, min: 5, type: 'analysis' }
        ];

        let jobRuns = [];
        let userTimezone = null; // User's timezone preference from settings

        async function fetchJobRuns() {
            try {
                const data = await cctApi.jobRuns(100);
                return data.success ? (data.data.runs || []) : [];
            } catch (e) {
                console.error('Failed to fetch job runs:', e);
                return [];
            }
        }

        function statusText(status) {
            return { success: '‚úÖ Completed', failed: '‚ùå Failed', running: 'üîÑ Running', partial: '‚ö†Ô∏è Partial' }[status] || '‚ö™ No run';
        }

        function formatTime(h, m) {
            const estH = (h - 5 + 24) % 24;
            const etTime = `${estH % 12 || 12}:${m.toString().padStart(2, '0')} ${estH >= 12 ? 'PM' : 'AM'} ET`;
            // Convert UTC to local time
            const utcDate = new Date(Date.UTC(2024, 0, 1, h, m));
            const localTime = utcDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            return `${etTime} (${localTime} local)`;
        }

        function parseDateUTC(dateStr) { return new Date(`${dateStr}T00:00:00Z`); }
        function getDateStr(d) { return d.toISOString().slice(0, 10); }
        
        function getUTCToday() {
            const now = new Date();
            return new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
        }

        function getLatestJobRunForDate(dateStr, reportType) {
            // Get latest run for this date and report type
            const runs = jobRuns.filter(j => j.scheduled_date === dateStr && j.report_type === reportType);
            if (runs.length === 0) return null;
            // Sort by created_at descending and return first
            return runs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
        }

        function renderDailySection() {
            const container = document.getElementById('daily-section');
            const now = new Date();
            const today = getUTCToday();

            // Use market day helper to get last market day
            const lastMarketDayStr = MarketDayHelper.getLastMarketDay();
            const lastMarketDay = parseDateUTC(lastMarketDayStr);

            // Determine if yesterday was a weekend
            const yesterday = new Date(today); yesterday.setUTCDate(today.getUTCDate() - 1);
            const yesterdayIsWeekend = yesterday.getUTCDay() === 0 || yesterday.getUTCDay() === 6;

            // If yesterday was a weekend, use last market day; otherwise use yesterday
            const showDate = yesterdayIsWeekend ? lastMarketDay : yesterday;
            const labelDate = yesterdayIsWeekend ? 'üìÜ Last Market Day' : 'üìÜ Yesterday';

            const renderRow = (date, label) => {
                const dateStr = getDateStr(date);
                const isToday = getDateStr(today) === dateStr;

                const cards = DAILY_JOBS.map(job => {
                    const run = getLatestJobRunForDate(dateStr, job.id);
                    const scheduledTime = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(), job.hour, job.min));
                    const isPast = scheduledTime < now;

                    let status, sText;
                    if (run) {
                        status = run.status; // success, failed, running, partial
                        sText = statusText(status);
                    } else if (!isToday || isPast) {
                        status = 'skipped';
                        sText = '‚ö™ No run';
                    } else {
                        status = 'scheduled';
                        sText = '‚è≥ Scheduled';
                    }

                    const reportLinks = {
                        'pre-market': '/pre-market-briefing',
                        'intraday': '/intraday-check',
                        'end-of-day': '/end-of-day-summary'
                    };
                    // Include run_id in link if available to view the specific run shown on card
                    const baseLink = reportLinks[job.id];
                    const reportLink = run?.run_id 
                        ? `${baseLink}?date=${dateStr}&run_id=${run.run_id}`
                        : (isToday ? baseLink : `${baseLink}?date=${dateStr}`);

                    return `
                        <a href="${reportLink}" class="job-card ${status}" style="text-decoration:none;color:inherit;display:block;">
                            <div class="job-header">
                                <span class="job-icon">${job.icon}</span>
                                <span class="job-time">${formatTime(job.hour, job.min)}</span>
                            </div>
                            <div class="job-name">${job.name}</div>
                            <div class="job-status">${sText}</div>
                            ${run ? `<div class="job-meta">Run: ${run.run_id.slice(-12)}</div>` : ''}
                        </a>
                    `;
                });

                return `
                    <div class="row-label">${label} ‚Äî ${date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</div>
                    <div class="daily-grid">${cards.join('')}</div>
                `;
            };

            container.innerHTML = renderRow(today, 'üìç Today') + renderRow(showDate, labelDate);
        }

        function renderWeeklySection() {
            const container = document.getElementById('weekly-section');
            const now = new Date();
            const today = getUTCToday();

            const thisSunday = new Date(today);
            thisSunday.setUTCDate(today.getUTCDate() - today.getUTCDay());
            const lastSunday = new Date(thisSunday);
            lastSunday.setUTCDate(thisSunday.getUTCDate() - 7);

            const renderWeeklyCard = (sunday, label) => {
                const dateStr = getDateStr(sunday);
                const isFuture = sunday > today;
                const isLastWeek = label === 'Last Week';
                const run = getLatestJobRunForDate(dateStr, 'weekly');

                let status, sText;
                if (run) {
                    status = run.status; // success, failed, running, partial
                    sText = statusText(status);
                } else if (isFuture) {
                    status = 'scheduled';
                    sText = '‚è≥ Scheduled';
                } else {
                    status = 'skipped';
                    sText = '‚ö™ No run';
                }

                const weekUrl = isLastWeek ? '/weekly-review?week=last' : '/weekly-review';

                return `
                    <a href="${weekUrl}" class="weekly-card ${status}" style="text-decoration:none;color:inherit;display:block;">
                        <div class="weekly-label">${label}</div>
                        <div class="weekly-date">üìã ${sunday.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</div>
                        <div class="weekly-status">${sText}</div>
                        ${run ? `<div class="job-meta">Run: ${run.run_id.slice(-12)}</div>` : ''}
                    </a>
                `;
            };

            container.innerHTML = `
                <div class="weekly-grid">
                    ${renderWeeklyCard(thisSunday, 'This Week')}
                    ${renderWeeklyCard(lastSunday, 'Last Week')}
                </div>
            `;
        }

        function renderMarketStatus() {
            const statusInfo = MarketDayHelper.getMarketStatus();
            const iconEl = document.getElementById('market-status-icon');
            const textEl = document.getElementById('market-status-text');

            if (statusInfo.status === 'OPEN') {
                iconEl.textContent = 'üü¢';
                textEl.textContent = `${statusInfo.message} ‚Ä¢ Last Market Day: ${statusInfo.lastMarketDayLabel}`;
            } else {
                iconEl.textContent = 'üî¥';
                textEl.textContent = `${statusInfo.message} ‚Ä¢ Last Market Day: ${statusInfo.lastMarketDayLabel}`;
            }
        }

        async function fetchJobRuns() {
            try {
                const data = await cctApi.jobRuns(50);
                return data.success ? (data.data.runs || []) : [];
            } catch (e) {
                console.error('Failed to fetch job runs:', e);
                return [];
            }
        }

        function formatRunTime(isoStr) {
            if (!isoStr) return '-';
            const d = new Date(isoStr);
            const baseOpts = { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true };
            if (userTimezone) {
                try {
                    return d.toLocaleString('en-US', { ...baseOpts, timeZone: userTimezone });
                } catch {
                    // Invalid timezone, fall back to browser default
                }
            }
            return d.toLocaleString('en-US', baseOpts);
        }

        function renderRunsSection() {
            const container = document.getElementById('runs-section');
            if (jobRuns.length === 0) {
                container.innerHTML = '<div class="loading">No job runs found</div>';
                return;
            }

            const reportLinks = {
                'pre-market': '/pre-market-briefing',
                'intraday': '/intraday-check',
                'end-of-day': '/end-of-day-summary',
                'weekly': '/weekly-review'
            };

            const reportIcons = {
                'pre-market': 'üåÖ',
                'intraday': 'üìä',
                'end-of-day': 'üåÜ',
                'weekly': 'üìã'
            };

            const rows = jobRuns.map(run => {
                const statusClass = run.status === 'success' ? 'success' : run.status === 'running' ? 'running' : run.status === 'partial' ? 'partial' : 'failed';
                const statusIcon = run.status === 'success' ? '‚úÖ' : run.status === 'running' ? 'üîÑ' : run.status === 'partial' ? '‚ö†Ô∏è' : '‚ùå';
                const reportUrl = reportLinks[run.report_type] ? `${reportLinks[run.report_type]}?run_id=${run.run_id}` : '#';
                const reportIcon = reportIcons[run.report_type] || 'üìÑ';
                const typeDisplay = reportLinks[run.report_type]
                    ? `<a href="${reportUrl}" style="color: var(--gold); text-decoration: none;">${reportIcon} ${run.report_type}</a>`
                    : `${reportIcon} ${run.report_type}`;

                // Trigger source icon with tooltip: ‚è∞ scheduled (GitHub Actions), üë§ manual
                // Handle variations: github_actions/github-actions/cron ‚Üí scheduled, manual/manual-api ‚Üí manual
                const src = (run.trigger_source || '').toLowerCase().replace(/-/g, '_');
                const isManual = src === 'manual' || src === 'manual_api' || src === 'unknown' || src === '';
                const triggerIcon = isManual
                    ? '<span class="trigger-icon manual" title="Manually triggered">üë§</span>'
                    : '<span class="trigger-icon scheduled" title="Scheduled (GitHub Actions)">‚è∞</span>';

                return `
                    <tr>
                        <td>${triggerIcon} ${run.scheduled_date}</td>
                        <td>${typeDisplay}</td>
                        <td><span class="run-status ${statusClass}">${statusIcon} ${run.status}</span></td>
                        <td>${formatRunTime(run.started_at)}</td>
                        <td>${formatRunTime(run.executed_at)}</td>
                        <td><span class="run-id">${run.run_id?.slice(-12) || '-'}</span></td>
                        <td>
                            <button class="delete-btn" onclick="deleteRun('${run.run_id}')" ${run.status === 'running' ? 'disabled' : ''}>üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <div class="legend-container">
                    <span style="color: var(--text-muted); font-weight: 500;">Legend:</span>
                    <div class="legend-item"><span>‚è∞</span> Scheduled (GitHub Actions)</div>
                    <div class="legend-item"><span>üë§</span> Manual trigger</div>
                    <div class="legend-item"><span>‚úÖ</span> Success</div>
                    <div class="legend-item"><span>‚ö†Ô∏è</span> Partial</div>
                    <div class="legend-item"><span>‚ùå</span> Failed</div>
                    <div class="legend-item"><span>üîÑ</span> Running</div>
                </div>
                <table class="runs-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Started</th>
                            <th>Completed</th>
                            <th>Run ID</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        async function deleteRun(runId) {
            if (!confirm('Delete this job run? This cannot be undone.')) return;

            try {
                const data = await cctApi.deleteJobRun(runId);
                if (data.success) {
                    alert('Run deleted successfully');
                    loadAll();
                } else {
                    alert('Failed to delete: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Delete failed: ' + e.message);
            }
        }

        async function triggerJob(jobType) {
            const symbols = prompt('Enter symbols (comma-separated):', 'AAPL,MSFT,GOOGL,NVDA,TSLA');
            if (!symbols) return;

            // Show loading state immediately
            document.getElementById('runs-section').innerHTML = `<div class="loading">Triggering ${jobType} job...</div>`;

            try {
                const symbolList = symbols.split(',').map(s => s.trim().toUpperCase());
                const data = await cctApi.triggerJob(jobType, symbolList);
                if (data.success) {
                    // Refresh immediately to show the new run
                    await loadAll();
                } else {
                    alert('Failed: ' + (data.error || 'Unknown error'));
                    loadAll();
                }
            } catch (e) {
                alert('Trigger failed: ' + e.message);
                loadAll();
            }
        }

        async function loadAll() {
            document.getElementById('daily-section').innerHTML = '<div class="loading">Loading...</div>';
            document.getElementById('weekly-section').innerHTML = '<div class="loading">Loading...</div>';
            document.getElementById('runs-section').innerHTML = '<div class="loading">Loading...</div>';

            // Render market status first
            renderMarketStatus();

            // Load user timezone preference (always re-read to catch Settings changes)
            try {
                userTimezone = localStorage.getItem('cct_timezone');
                if (!userTimezone) {
                    const tzData = await cctApi.getTimezone();
                    userTimezone = tzData.timezone || null;
                }
            } catch {
                userTimezone = null;
            }

            // Fetch job runs (single source of truth)
            jobRuns = await fetchJobRuns();
            renderDailySection();
            renderWeeklySection();
            renderRunsSection();
        }

        loadAll();
        // Auto-refresh every 5 minutes (300000ms) - use memory manager to prevent leaks
        memoryManager.registerInterval('dashboard-refresh', loadAll, 300000);
    </script>
</body>
</html>
