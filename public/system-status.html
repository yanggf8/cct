<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Status - CCT Trading</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="/css/nav.css?v=20251226">
    <script src="/js/nav.js?v=20251226"></script>
    <script src="/js/cct-api.js"></script>
    <script src="/js/utils/memory-manager.js"></script>
    <script src="/js/utils/shared-utils.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(160deg, #1a1714 0%, #1f1b16 40%, #2a241c 100%);
            background-attachment: fixed;
            color: #faf8f5;
            min-height: 100vh;
            padding: 20px;
            padding-top: 80px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { margin-bottom: 30px; color: #fcd535; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .status-card {
            background: rgba(250, 248, 245, 0.03);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(240, 185, 11, 0.12);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        .status-card:hover {
            background: rgba(250, 248, 245, 0.06);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(240, 185, 11, 0.08);
        }
        .status-card h3 { margin-bottom: 15px; font-size: 1.1rem; color: #f0b90b; }
        .status-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(240, 185, 11, 0.08); }
        .status-item:last-child { border-bottom: none; }
        .status-item span:first-child { color: rgba(250, 248, 245, 0.88); }
        .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; color: #fff; font-weight: 600; }
        .status-badge.healthy { background: #10b981; }
        .status-badge.warning { background: #f59e0b; }
        .status-badge.error { background: #ef4444; }
        .status-badge.pending { background: rgba(250, 248, 245, 0.3); }
        .refresh-info { text-align: center; margin-top: 20px; color: rgba(250, 248, 245, 0.65); font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç System Status</h1>
        <div class="status-grid" id="status-grid">
            <div class="status-card">
                <h3>‚è≥ Loading...</h3>
            </div>
        </div>
        <div class="refresh-info">Auto-refreshes every 30 seconds</div>
    </div>
    <script>
        async function loadStatus() {
            try {
                const data = await cctApi.systemStatus();
                renderStatus(data);
            } catch (e) {
                document.getElementById('status-grid').innerHTML = '<div class="status-card"><h3>‚ùå Failed to load status</h3></div>';
            }
        }

        function badge(status) {
            const s = String(status || 'unknown').toLowerCase();
            const cls = ['healthy', 'operational', 'available', 'success', 'completed'].includes(s) ? 'healthy' 
                : ['warning', 'degraded'].includes(s) ? 'warning' 
                : ['pending', 'unknown', 'scheduled'].includes(s) ? 'pending' 
                : 'error';
            return `<span class="status-badge ${cls}">${status || 'unknown'}</span>`;
        }

        function renderStatus(d) {
            const api = d.api || {};
            const categories = api.categories || {};
            const categoryList = Object.entries(categories).map(([name, info]) => 
                `<div class="status-item"><span>${name}</span>${badge(info?.status)} <small>(${info?.count})</small></div>`
            ).join('');

            const html = `
                <div class="status-card">
                    <h3>üåê System Overview</h3>
                    <div class="status-item"><span>Status</span>${badge(d.status)}</div>
                    <div class="status-item"><span>Uptime</span><span>${d.uptime || 'N/A'}</span></div>
                    <div class="status-item"><span>Response Time</span><span>${d.responseTime || 'N/A'}</span></div>
                </div>
                <div class="status-card">
                    <h3>üîå API Status</h3>
                    <div class="status-item"><span>Overall</span>${badge(api.status)}</div>
                    <div class="status-item"><span>Version</span><span>${api.version || 'v1'}</span></div>
                    <div class="status-item"><span>Total Endpoints</span><span>${api.totalEndpoints || 'N/A'}</span></div>
                    <div class="status-item"><span>Base URL</span><span>${api.baseUrl || '/api/v1'}</span></div>
                </div>
                <div class="status-card">
                    <h3>üì° API Categories</h3>
                    ${categoryList || '<div class="status-item"><span>No categories</span></div>'}
                </div>
                <div class="status-card">
                    <h3>üíæ Cache Status</h3>
                    <div class="status-item"><span>L1 Cache</span>${badge(d.cache?.l1?.status)}</div>
                    <div class="status-item"><span>L1 Hit Rate</span><span>${d.cache?.l1?.hitRate || 'N/A'}</span></div>
                    <div class="status-item"><span>L2 Cache</span>${badge(d.cache?.l2?.status)}</div>
                </div>
                <div class="status-card">
                    <h3>üóÑÔ∏è Database Status</h3>
                    <div class="status-item"><span>D1</span>${badge(d.database?.status)}</div>
                    <div class="status-item"><span>Jobs Stored</span><span>${d.database?.jobCount || 0}</span></div>
                    <div class="status-item"><span>Last Job</span><span>${d.database?.lastJob ? new Date(d.database.lastJob).toLocaleString() : 'N/A'}</span></div>
                </div>
                <div class="status-card">
                    <h3>ü§ñ AI Models</h3>
                    <div class="status-item"><span>Gemma Sea Lion 27B</span>${badge(d.models?.gemmaSeaLion?.status)}</div>
                    <div class="status-item"><span>DistilBERT-SST-2</span>${badge(d.models?.distilbert?.status)}</div>
                </div>
                <div class="status-card">
                    <h3>‚è∞ Today's Jobs</h3>
                    <div class="status-item"><span>Pre-Market</span><span>${badge(d.jobs?.preMarket?.status)} ${d.jobs?.preMarket?.lastRun || d.jobs?.preMarket?.scheduled || ''}</span></div>
                    <div class="status-item"><span>Intraday</span><span>${badge(d.jobs?.intraday?.status)} ${d.jobs?.intraday?.lastRun || d.jobs?.intraday?.scheduled || ''}</span></div>
                    <div class="status-item"><span>End-of-Day</span><span>${badge(d.jobs?.endOfDay?.status)} ${d.jobs?.endOfDay?.lastRun || d.jobs?.endOfDay?.scheduled || ''}</span></div>
                    <div class="status-item"><span>Weekly</span><span>${badge(d.jobs?.weekly?.status)} ${d.jobs?.weekly?.lastRun || d.jobs?.weekly?.scheduled || ''}</span></div>
                </div>
                <div class="status-card">
                    <h3>üì∞ Article Pool (DAC)</h3>
                    <div class="status-item"><span>Pool Status</span>${badge(d.articlePool?.status)}</div>
                    <div class="status-item"><span>Symbols with Articles</span><span>${d.articlePool?.available || 0} / 10</span></div>
                    ${d.articlePool?.missing?.length ? `<div class="status-item"><span>Missing</span><span style="color:#ef4444;font-size:0.85rem">${d.articlePool.missing.join(', ')}</span></div>` : ''}
                    ${Object.entries(d.articlePool?.symbols || {}).slice(0, 5).map(([sym, info]) => 
                        `<div class="status-item"><span>${sym}</span><span>${info.count} articles${info.stale ? ' <small style="color:#f59e0b">(stale)</small>' : ''}</span></div>`
                    ).join('')}
                </div>
            `;
            document.getElementById('status-grid').innerHTML = html;
        }

        loadStatus();
        // Auto-refresh every 30 seconds (30000ms) - use memory manager to prevent leaks
        memoryManager.registerInterval('status-refresh', loadStatus, 30000);
    </script>
</body>
</html>
