name = "tft-trading-system"
main = "src/index.ts"
compatibility_date = "2025-01-10"
compatibility_flags = ["nodejs_compat"]
account_id = "ed01ccea0b8ee7138058c4378cc83e54"
minify = true

# Static assets from public folder
[assets]
directory = "public"

# D1 Database for prediction job results
[[d1_databases]]
binding = "PREDICT_JOBS_DB"
database_name = "cct-predict-jobs"
database_id = "dbcb468d-ec04-4e3b-87c5-748d5a30ff40"

[env.staging]
name = "tft-trading-system-staging"
main = "src/index.ts"

[[env.staging.durable_objects.bindings]]
name = "CACHE_DO"
class_name = "CacheDurableObject"

[[env.staging.d1_databases]]
binding = "PREDICT_JOBS_DB"
database_name = "cct-predict-jobs-staging"
database_id = "6e50380f-4b98-4ed9-a766-446d0bcedee4"

# KV bindings - Market Analysis & Operations Cache (stores analysis results, market data, job status)
[[kv_namespaces]]
binding = "MARKET_ANALYSIS_CACHE"
id = "321593c6717448dfb24ea2bd48cde1fa"
preview_id = "220ca67255ed4bfeada7eb6816ce6413"

# NOTE: CACHE_DO_KV removed - was duplicate of TRADING_RESULTS
# Durable Objects cache uses CACHE_DO binding for persistent memory
# If separate KV needed for DO cache, create new namespace with unique ID

# R2 bindings
[[r2_buckets]]
binding = "TFT_TRADING_MODELS"
bucket_name = "tft-trading-models"

# AI bindings
[ai]
binding = "AI"

# DAC Service Binding (direct Worker-to-Worker communication)
[[services]]
binding = "DAC_BACKEND"
service = "dac-backend"

# Durable Objects for cache
[[durable_objects.bindings]]
name = "CACHE_DO"
class_name = "CacheDurableObject"

[[durable_objects.bindings]]
name = "RATE_LIMITER_DO"
class_name = "RateLimiterDO"

[[durable_objects.bindings]]
name = "PORTFOLIO_DO"
class_name = "PortfolioDO"

# Durable Objects migrations
[[migrations]]
tag = "v1"
new_sqlite_classes = ["CacheDurableObject"]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["RateLimiterDO"]

[[migrations]]
tag = "v3"
new_sqlite_classes = ["PortfolioDO"]

# Scheduled events (DISABLED - Migrated to GitHub Actions)
# All prediction scheduling now handled by .github/workflows/trading-system.yml
# Migration Benefits: Unlimited schedules, 100% free, better observability
# Cloudflare cron had 3-schedule limit and $0.20/month DO cost
# [[triggers.crons]]
# cron = "0 9 * * 1-5"  # 9 AM weekdays - NOW HANDLED BY GITHUB ACTIONS

# Variables
[vars]
ENVIRONMENT = "production"
WORKER_VERSION = "2.0-enhanced"
LOG_LEVEL = "info"
# AI model configuration
GPT_MAX_TOKENS = "2000"
GPT_TEMPERATURE = "0.1"
# Analysis configuration
MIN_NEWS_ARTICLES = "5"
MAX_NEWS_ARTICLES = "20"
CONFIDENCE_THRESHOLD = "0.6"
SIGNAL_CONFIDENCE_THRESHOLD = "0.7"
# KV storage TTL (in seconds)
KV_ANALYSIS_TTL = "604800"  # 7 days
KV_GRANULAR_TTL = "7776000" # 90 days
# Market data configuration
MARKET_DATA_CACHE_TTL = "300" # 5 minutes
YAHOO_FINANCE_RATE_LIMIT = "20" # 20 requests per minute
RATE_LIMIT_WINDOW = "60000" # 1 minute in milliseconds
# Durable Objects cache configuration
FEATURE_FLAG_DO_CACHE = "true" # DO cache enabled - eliminates KV writes, 50x faster performance
# DAC Articles Pool Integration
DAC_ARTICLES_POOL_URL = "https://dac-backend.yanggf.workers.dev"
# FRED API graceful degradation (uses Yahoo Finance fallback when FRED_API_KEY not set)
FRED_ALLOW_DEGRADATION = "true"

# Secrets to be set via: wrangler secret put SECRET_NAME
# Core secrets:
# - WORKER_API_KEY: API key for protecting sensitive endpoints (REQUIRED)
# - FACEBOOK_PAGE_TOKEN: Facebook Messenger bot token
# - FACEBOOK_RECIPIENT_ID: Your Facebook user ID
#
# Free News API keys:
# - FMP_API_KEY: Financial Modeling Prep free API key (financialmodelingprep.com)
# - NEWSAPI_KEY: NewsAPI.org free development key (newsapi.org)
#
# DAC Integration:
# - DAC_ARTICLES_POOL_API_KEY: API key for DAC articles pool (optional, may use public endpoints)
#
# Optional secrets:
# - SLACK_WEBHOOK_URL: Slack webhook for alerts
# - ALERT_EMAIL: Email address for trading alerts
# - LINE_CHANNEL_TOKEN: LINE messaging API token
# - LINE_USER_ID: Your LINE user ID
#
# Example deployment commands:
# wrangler secret put WORKER_API_KEY
# wrangler secret put FMP_API_KEY
# wrangler secret put NEWSAPI_KEY
# wrangler secret put DAC_ARTICLES_POOL_API_KEY
